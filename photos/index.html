{% capture body %}
  <main class="l-photos">
    {{body}}
  </main>
  <script>
    (function(){
      var LazyLoad = function LazyLoad (container, url) {
        this.container = document.querySelector(container)
        var xhr = new XMLHttpRequest()
          , self = this
        xhr.onload = function () {
          self.reqListener(this)
        }
        xhr.open('GET', url, true)
        xhr.send()
      }

      LazyLoad.prototype = {
        loop: function loop(list, fn) {
          if (!list || list.length <= 0) return
          (function chain(i) {
            if (i >= list.length) return
            fn(list[i], function() {
              chain(i + 1)
            })
          })(0)
        },

        appendPhoto: function appendPhoto () {
          this.container.appendChild(this.figure)
          window.setTimeout(this.next, 100)
        },

        buildPhoto: function buildPhoto (photo, next) {
          var self = this
          this.next = next
          this.figure = document.createElement('figure')
          this.figure.className = 'image'
          var time = document.createElement('time')
          time.className = 'image-time'
          time.innerText = photo.human_date
          var img = new Image()
          img.alt = photo.title
          this.figure.appendChild(img)
          this.figure.appendChild(time)
          img.onload = function () {
            self.appendPhoto()
          }
          img.src = photo.url
        },

        reqListener: function reqListener (xhr) {
          var photos = JSON.parse(xhr.responseText)
            , self = this
          this.loop(photos, function (photo, next) {
            self.buildPhoto(photo, next)
          })
        }
      }

      new LazyLoad('.l-photos', '/photos/photos.json')
    })()
  </script>
{% endcapture %}

{% include 'layouts/default' %}
